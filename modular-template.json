{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "sparkClusterName": {
            "type": "string",
            "metadata": {
                "description": "The name of the Spark cluster to create. This must be a unique name."
            }
        },
        "kafkaClusterName": {
            "type": "string",
            "metadata": {
                "description": "The name of the Kafka cluster to create. This must be a unique name."
            }
        },
        "clusterLoginUserName": {
            "type": "string",
            "defaultValue": "admin",
            "metadata": {
                "description": "These credentials can be used to submit jobs to the clusters and to log into clusters dashboards."
            }
        },
        "clusterLoginPassword": {
            "type": "securestring",
            "defaultValue": "Micr0pwd!@",
            "metadata": {
                "description": "The password must be at least 10 characters in length and must contain at least one digit, one non-alphanumeric character, and one upper or lower case letter."
            }
        },
        "sshUserName": {
            "type": "string",
            "defaultValue": "sshuser",
            "metadata": {
                "description": "These credentials can be used to remotely access the clusters."
            }
        },
        "sshPassword": {
            "type": "securestring",
            "defaultValue": "Micr0pwd!@",
            "metadata": {
                "description": "The password must be at least 10 characters in length and must contain at least one digit, one non-alphanumeric character, and one upper or lower case letter."
            }
        },
        "sqlAdminLogin": {
            "type": "string",
            "defaultValue": "sqluser",
            "metadata": {
                "description": "These credentials can be used to access the Azure SQL database."
            }
        },
        "sqlAdminPassword": {
            "type": "securestring",
            "defaultValue": "Micr0pwd!@",
            "metadata": {
                "description": "The password can be used to access the SQL database.The password must be at least 10 characters in length and must contain at least one digit, one non-alphanumeric character, and one upper or lower case letter."
            }
        }
    },
    "variables": {
        "blobStorageAccount": {
            "name": "[concat(uniqueString(resourceGroup().name),'blob')]",
            "type": "Standad_LRS"
        },
        "ADLSGen2StorageName": "adlsclusterstore992020",
        "sqlDatabase": {
            "serverName": "sqlforpredictions",
            "databaseName": "Predictions"
        },
        "managedIdentityName": "[concat(uniqueString(resourceGroup().id),'mi')]",
        "storageBlobOwner": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Authorization/roleDefinitions/', 'b7e6dc6d-f1e8-4753-8033-0f276bb0955b')]",
        "roleAssignmentName": "[concat(variables('ADLSGen2StorageName'), '/Microsoft.Authorization/',guid(resourceGroup().id))]",
        "roleName": "[guid(resourceGroup().id)]"
    },
    "resources": [
        {
            "name": "[variables('managedIdentityName')]",
            "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
            "apiVersion": "2018-11-30",
            "tags": {},
            "location": "[resourceGroup().location]"
        },
        {
            "name": "[variables('ADLSGen2StorageName')]",
            "type": "Microsoft.Storage/storageAccounts",
            "dependsOn": [
                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities',variables('managedIdentityName'))]"
            ],
            "apiVersion": "2019-06-01",
            "tags": {
                "displayName": "[variables('ADLSGen2StorageName')]"
            },
            "location": "[resourceGroup().location]",
            "kind": "StorageV2",
            "sku": {
                "name": "Standard_LRS",
                "tier": "Standard"
            },
            "properties": {
                "isHnsEnabled": true,
                "accessTier": "Hot",
                "networkAcls": {
                    "defaultAction": "Allow",
                    "bypass": "AzureServices"
                }
            },
            "resources": [
                {
                    "type": "Microsoft.Storage/storageAccounts/providers/roleAssignments",
                    "name": "[variables('roleAssignmentName')]",
                    "apiVersion": "2020-04-01-preview",
                    "dependsOn": [ "[resourceId('Microsoft.Storage/storageAccounts', variables('ADLSGen2StorageName'))]" ],
                    "properties": {
                        "roleDefinitionId": "[variables('storageBlobOwner')]",
                        "principalId": "[reference(variables('managedIdentityName'), '2018-11-30').principalId]",
                        "principalType": "ServicePrincipal"
                    }

                }
            ]
        },
        {
            "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
            "apiVersion": "2019-06-01",
            "name": "[concat(variables('ADLSGen2StorageName'), '/default/data')]",
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', variables('ADLSGen2StorageName'))]"
            ],
            "properties": {
                "publicAccess": "Container"
            }
        },
        {
            "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
            "apiVersion": "2019-06-01",
            "name": "[concat(variables('ADLSGen2StorageName'), '/default/models')]",
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', variables('ADLSGen2StorageName'))]"
            ],
            "properties": {
                "publicAccess": "Container"
            }
        },
        {
            "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
            "apiVersion": "2019-06-01",
            "name": "[concat(variables('ADLSGen2StorageName'), '/default/predictions')]",
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', variables('ADLSGen2StorageName'))]"
            ],
            "properties": {
                "publicAccess": "Container"
            }
        },
        {
            "type": "Microsoft.Storage/storageAccounts",
            "apiVersion": "2019-06-01",
            "name": "[variables('blobStorageAccount').name]",
            "sku": {
                "name": "Standard_LRS",
                "tier": "Standard"
            },
            "kind": "StorageV2",
            "location": "[resourceGroup().location]",
            "resources": [
                {
                    "type": "blobServices/containers",
                    "apiVersion": "2019-06-01",
                    "name": "default/data",
                    "dependsOn": [
                        "[resourceId('Microsoft.Storage/storageAccounts',variables('blobStorageAccount').name)]"
                    ],
                    "properties": {
                        "publicAccess": "Container"
                    }
                }
            ]
        },

        {
            "name": "[variables('sqlDatabase').serverName]",
            "type": "Microsoft.Sql/servers",
            "apiVersion": "2019-06-01-preview",
            "location": "[resourceGroup().location]",
            "tags": {
                "displayName": "[variables('sqlDatabase').serverName]"
            },
            "properties": {
                "administratorLogin": "[parameters('sqlAdminLogin')]",
                "administratorLoginPassword": "[parameters('sqlAdminPassword')]"
            },
            "resources": [
                {
                    "type": "firewallRules",
                    "apiVersion": "2015-05-01-preview",
                    "dependsOn": [
                        "[resourceId('Microsoft.Sql/servers', variables('sqlDatabase').serverName)]"
                    ],
                    "location": "[resourceGroup().location]",
                    "name": "AllowAllWindowsAzureIps",
                    "properties": {
                        "startIpAddress": "0.0.0.0",
                        "endIpAddress": "0.0.0.0"
                    }
                },
                {
                    "type": "databases",
                    "apiVersion": "2019-06-01-preview",
                    "name": "[variables('sqlDatabase').databaseName]",
                    "location": "[resourceGroup().location]",
                    "sku": {
                        "name": "Standard",
                        "tier": "Standard"
                    },
                    "dependsOn": [ "[resourceId('Microsoft.Sql/servers', variables('sqlDatabase').serverName)]" ],
                    "properties": {
                        "createMode": "Default"
                    }
                }
            ]
        },
         
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "ClusterTemplate",
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts',variables('ADLSGen2StorageName'))]",
                "[extensionResourceId(resourceId('Microsoft.Storage/storageAccounts',variables('ADLSGen2StorageName')),'Microsoft.Storage/storageAccounts/providers/roleAssignments',variables('roleName'))]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink":{
                    "uri": "https://raw.githubusercontent.com/SindhuRaghvan/HDITemplateforInsurance/master/cluster-template.json"
                },
                "parameters": {
                    "sparkClusterName": {"value": "[parameters('sparkClusterName')]"},
                    "kafkaClusterName":{"value": "[parameters('kafkaClusterName')]"},
                    "clusterLoginUserName": {"value":"[parameters('clusterLoginUserName')]"},
                    "clusterLoginPassword": {"value":"[parameters('clusterLoginPassword')]"},
                    "sshUserName": {"value":"[parameters('sshUserName')]"},
                    "sshPassword":{"value": "[parameters('sshPassword')]"},
                    "ADLSGen2StorageName": {"value":"[variables('ADLSGen2StorageName')]"},
                    "managedIdentityName":{"value": "[variables('managedIdentityName')]"}
                }

        }
        }


    ],
    "outputs": {

    }
}
